import { FormData } from "./types";

// ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ sendToTelegram Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
export async function sendToTelegram(data: FormData) {
  try {
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ

    const botToken = import.meta.env.VITE_TELEGRAM_BOT_TOKEN;
    const chatId = import.meta.env.VITE_TELEGRAM_CHAT_ID;

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
    if (!botToken || !chatId) {
      console.warn(
        "Telegram configuration is missing. Using mock response for development."
      );
      // Ð’ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¸Ð»Ð¸ ÐµÑÐ»Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
      return { success: true, mock: true };
    }

    // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    const message = `
ðŸŽ‰ ÐÐ¾Ð²Ð°Ñ Ð·Ð°ÑÐ²ÐºÐ° Ð½Ð° ÑÐ²Ð°Ð´ÑŒÐ±Ñƒ!

ðŸ‘¤ Ð“Ð¾ÑÑ‚ÑŒ: ${data.mainGuest}
âœ… ÐŸÑ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ: ${data.attending ? "Ð”Ð°" : "ÐÐµÑ‚"}

${
  data.additionalGuests && data.additionalGuests.length > 0
    ? `ðŸ‘¥ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð³Ð¾ÑÑ‚Ð¸:
${data.additionalGuests
  .filter((g) => g.name.trim() !== "")
  .map((g) => `- ${g.name}`)
  .join("\n")}`
    : ""
}

ðŸ· ÐŸÑ€ÐµÐ´Ð¿Ð¾Ñ‡Ñ‚ÐµÐ½Ð¸Ñ:
${data.preferences.strongAlcohol ? "- ÐšÑ€ÐµÐ¿ÐºÐ¸Ð¹ Ð°Ð»ÐºÐ¾Ð³Ð¾Ð»ÑŒ\n" : ""}${
      data.preferences.redWine ? "- ÐšÑ€Ð°ÑÐ½Ð¾Ðµ Ð²Ð¸Ð½Ð¾\n" : ""
    }${data.preferences.whiteWine ? "- Ð‘ÐµÐ»Ð¾Ðµ Ð²Ð¸Ð½Ð¾" : ""}
`.trim();

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Telegram
    const url = `https://api.telegram.org/bot${botToken}/sendMessage`;

    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        chat_id: chatId,
        text: message,
      }),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      console.error("Telegram API error:", response.status, errorData);
      throw new Error(`Telegram API error: ${response.status}`);
    }

    return { success: true };
  } catch (error) {
    console.error("Error sending message to Telegram:", error);
    // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÑƒ, Ð½Ð¾ Ð½Ðµ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ
    return { success: false, error: String(error) };
  }
}
